<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Power-Up Collection Game with Enhanced Mechanics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #modalInstructions, #gameOverModal, #upgradeShopModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        #modalInstructions button, #gameOverModal button, #upgradeShopModal button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            margin-right: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        #modalInstructions button:hover, #gameOverModal button:hover, #upgradeShopModal button:hover {
            background-color: #0056b3;
        }
        #testModeDiv, #audioControls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        #audioControls {
            top: 40px;
        }
    </style>
</head>
<body>
    <div id="testModeDiv">
        <label>
            <input type="checkbox" id="testModeCheckbox" />
            Test Mode
        </label>
    </div>
    <audio id="bgMusic" loop autoplay>
        <source src="Limit 70.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>
    <audio id="bluePowerUpSound" src="sound/blue_beep.mp3"></audio>
    <audio id="yellowPowerUpSound" src="sound/yellow_beep.mp3"></audio>
    <audio id="greenPowerUpSound" src="sound/green_beep.mp3"></audio>
    <audio id="redPowerUpSound" src="sound/red_beep.mp3"></audio>
    <audio id="purplePowerUpSound" src="sound/purple_beep.mp3"></audio>
    <div id="modalInstructions">
        <p>Collect as many circles before time runs out.</p>
        <p>Yellow = 3, Purple = 2, Green & Blue = 1.</p>
        <p>Purple will give you 3 extra seconds.</p>
        <p>Blue circles temporarily make you bigger. Green ones add to your boost inventory.</p>
        <p>Avoid Red altogether!</p>
        <p>Use arrow keys or WASD to move.</p>
        <button onclick="startGame()">Start Game</button>
    </div>
    <div id="gameOverModal" style="display:none;">
        <p>Game Over</p>
        <p>Final Score: <span id="finalScoreDisplay">0</span></p>
        <p>High Score: <span id="highScoreDisplay">0</span></p>
        <div id="nftOfferContainer" style="display:none;">
            <p>Congratulations! You're eligible for an NFT reward.</p>
            <a href="https://highlight.xyz/mint/65da3c6c14d1e1cf26028c87" target="_blank">Claim your NFT</a>
        </div>
        <button onclick="restartGame()">Restart Game</button>
    </div>
    <div id="upgradeShopModal" style="display:none;">
        <h2>Upgrade Shop</h2>
        <p>You have collected enough yellow power-ups to access the upgrade shop.</p>
        <button onclick="purchaseUpgrade('healthBoost')">Health Boost (+25)</button>
        <button onclick="purchaseUpgrade('speedBoost')">Speed Boost (+2)</button>
        <button onclick="purchaseUpgrade('magnet')">Magnet (+2)</button>
        <button onclick="purchaseUpgrade('ammo')">Ammo (+6)</button>
        <button onclick="closeUpgradeShop()">Close</button>
    </div>
    <script>
        let magnetActive = false;
        let magnetRadius = 100;
        let magnetStrength = 2;
        let baseSpeed = 5;
        let playerPosition;
        let playerPositionHistory = [];
        let playerSize = 20;
        let powerUps = [];
        let powerUpSize = 15;
        let inventory = {};
        let isBluePowerUpActive = false;
        let bluePowerUpDuration = 100;
        let bluePowerUpTimer = 0;
        let score = 0;
        let timer;
        let timerDuration = 1200;
        let isGreenPowerUpActive = false;
        let greenPowerUpTimer = 0;
        let velocityBoost = 5;
        let maxHealth = 100;
        let currentHealth = maxHealth;
        let redSpeedIncrement = 5;
        let redMaxSpeed = 5;
        let redSpeed = 1;
        let testModeActive = false;
        let isHit = false;
        let hitDuration = 15;
        let hitTimer = 0;
        let isYellowEffectActive = false;
        let yellowEffectDuration = 60;
        let yellowEffectTimer = 0;
        let globalFinalScore;
        let yellowPowerUpsCollected = 0;
        const yellowPowerUpThreshold = 5;
        const pointValues = {
          yellow: 3,
          purple: 2,
          green: 1,
          blue: 1
        };

        // Projectile variables
        let projectiles = [];
        let ammoTotal = 12;
        let ammoClip = 6;
        let isReloading = false;
        let reloadDuration = 120; // Frames to reload (2 seconds at 60fps)
        let reloadTimer = 0;
        let lastShotTime = 0;
        let shootInterval = 15; // Frames between shots
        let canShoot = true;

        // Green boost variables
        let greenBoostCount = 0;
        const maxGreenBoost = 3;
        let isBoosting = false;
        let boostCooldown = 120; // Frames (2 seconds)
        let boostTimer = 0;

        function startGame() {
            document.getElementById('modalInstructions').style.display = 'none';
            loop();
        }

        function setup() {
            createCanvas(800, 640);
            playerPosition = createVector(width / 2, height / 2);
            addPowerUps(5);
            timer = timerDuration;
            noLoop();
            document.getElementById('testModeCheckbox').addEventListener('change', function() {
                testModeActive = this.checked;
                if (testModeActive) {
                    console.log("Test Mode Activated");
                } else {
                    console.log("Test Mode Deactivated");
                }
            });
        }

        function checkGameOver() {
            if (testModeActive) {
                return;
            }
            if (currentHealth <= 0 || timer <= 0) {
                showGameOverModal();
                noLoop();
            }
        }
        
        function showGameOverModal() {
            const timeAlive = Math.max(0, (timerDuration - timer) / 60);
            const finalScore = Math.max(0, score) * timeAlive;
            console.log("Final Score:", finalScore.toFixed(2));
            let highScore = parseFloat(localStorage.getItem('highScore') || '0');
            if (finalScore > highScore) {
                localStorage.setItem('highScore', finalScore.toString());
                highScore = finalScore;
            }
            document.getElementById('highScoreDisplay').textContent = highScore.toFixed(2);
            document.getElementById('finalScoreDisplay').textContent = finalScore.toFixed(2);
            document.getElementById('gameOverModal').style.display = 'flex';
            const nftEligibleScore = 2000;
            if (finalScore > nftEligibleScore) {
                document.getElementById('nftOfferContainer').style.display = 'block';
            } else {
                document.getElementById('nftOfferContainer').style.display = 'none';
            }
        }

        function restartGame() {
            currentHealth = maxHealth;
            timer = timerDuration;
            score = 0;
            powerUps = [];
            addPowerUps(5);
            playerPosition = createVector(width / 2, height / 2);
            playerSize = 20;
            magnetActive = false;
            magnetRadius = 100;
            magnetStrength = 2;
            baseSpeed = 5;
            yellowPowerUpsCollected = 0;
            ammoTotal = 12;
            ammoClip = 6;
            isReloading = false;
            reloadTimer = 0;
            projectiles = [];
            greenBoostCount = 0;
            isBoosting = false;
            boostTimer = 0;
            document.getElementById('gameOverModal').style.display = 'none';
            loop();
        }

        function updatePlayerPositionHistory() {
            playerPositionHistory.unshift({x: playerPosition.x, y: playerPosition.y});
            if (playerPositionHistory.length > 5) {
                playerPositionHistory.pop();
            }
        }
        
        function draw() {
            background(0);
            handlePlayerInput();
            updatePowerUps();
            handleProjectiles();
            handleReload();
            handleBoost();
            drawPlayer();
            drawPowerUps();
            updateAndDisplayTimer();
            drawHealthBar();
            drawScoreboard();
            displayHUD();
            maybeAddPowerUp();
            checkGameOver();
        }

        function updatePowerUps() {
            powerUps.forEach(powerUp => {
                if (!powerUp.collected) {
                    let direction = p5.Vector.sub(playerPosition, powerUp.position);
                    let distance = direction.mag();
                    direction.normalize();
                    if (powerUp.color === 'red') {
                        if (isBluePowerUpActive) {
                            direction.mult(-1);
                        }
                        let currentRedSpeed = min(redSpeed + (score / 40) * redSpeedIncrement, redMaxSpeed);
                        direction.mult(currentRedSpeed);
                    } else {
                        if (magnetActive && distance < magnetRadius) {
                            direction.mult(magnetStrength);
                        } else {
                            direction.mult(0);
                        }
                    }
                    if (magnetActive || powerUp.color === 'red') {
                        powerUp.position.add(direction);
                    }
                }
            });
        }

        function displayHUD() {
            // Ammo HUD
            let ammoX = 10;
            let ammoY = height - 60;
            let ammoSpacing = 30;
            for (let i = 0; i < 6; i++) {
                if (i < ammoClip) {
                    fill(255, 255, 0); // Filled circle for available ammo
                } else {
                    noFill();
                }
                stroke(255);
                ellipse(ammoX + i * ammoSpacing, ammoY, 20, 20);
            }

            // Reload Indicator
            if (isReloading) {
                push();
                translate(ammoX + 3 * ammoSpacing, ammoY);
                rotate((frameCount % 360) * PI / 180);
                noFill();
                stroke(0, 255, 0);
                strokeWeight(4);
                arc(0, 0, 30, 30, 0, map(reloadTimer, 0, reloadDuration, 0, TWO_PI));
                pop();
            }

            // Green Boost HUD
            let boostX = 10;
            let boostY = height - 20;
            let boostSpacing = 30;
            for (let i = 0; i < maxGreenBoost; i++) {
                if (i < greenBoostCount) {
                    fill(0, 255, 0); // Filled circle for available boosts
                } else {
                    noFill();
                }
                stroke(255);
                ellipse(boostX + i * boostSpacing, boostY, 20, 20);
            }

            // Boost Cooldown Indicator
            if (boostTimer > 0) {
                fill(255, 0, 0, 150);
                noStroke();
                rect(10, height - 80, map(boostTimer, 0, boostCooldown, 0, 100), 10);
                fill(255);
                textSize(12);
                textAlign(LEFT, TOP);
                text(`Boost Cooldown: ${(boostTimer / 60).toFixed(1)}s`, 10, height - 90);
            }

            // Boosting Indicator
            if (isBoosting) {
                fill(0, 255, 0);
                noStroke();
                textSize(16);
                textAlign(LEFT, TOP);
                text("Boosting!", 150, height - 60);
            }
        }

        function mousePressed() {
            if (mouseButton === LEFT && !isReloading && ammoClip > 0) {
                shootProjectile();
            }
        }

        function keyPressed() {
            if (key === 'R' || key === 'r') {
                if (!isReloading && ammoClip < 6 && ammoTotal > 0) {
                    startReload();
                }
            }
            if (key === ' ' ) {
                useBoost();
            }
        }

        function handlePlayerInput() {
            let speed = baseSpeed;
            if (isBoosting) {
                speed *= velocityBoost;
            }
            if (keyIsDown(87) || keyIsDown(UP_ARROW)) {
                playerPosition.y -= speed;
            }
            if (keyIsDown(83) || keyIsDown(DOWN_ARROW)) {
                playerPosition.y += speed;
            }
            if (keyIsDown(65) || keyIsDown(LEFT_ARROW)) {
                playerPosition.x -= speed;
            }
            if (keyIsDown(68) || keyIsDown(RIGHT_ARROW)) {
                playerPosition.x += speed;
            }
            // Wrap around screen edges
            if (playerPosition.y < 0) playerPosition.y = height;
            if (playerPosition.y > height) playerPosition.y = 0;
            if (playerPosition.x < 0) playerPosition.x = width;
            if (playerPosition.x > width) playerPosition.x = 0;
        }

        function drawPlayer() {
            let playerColor = isYellowEffectActive ? lerpColor(color(255, 255, 0), color(255), map(yellowEffectTimer, yellowEffectDuration, 0, 0, 1)) : color(255);
            if (isGreenPowerUpActive) {
                for (let i = 0; i < playerPositionHistory.length; i++) {
                    let pos = playerPositionHistory[i];
                    let alpha = map(i, 0, playerPositionHistory.length, 255, 0);
                    fill(255, 255, 255, alpha);
                    square(pos.x - playerSize / 2, pos.y - playerSize / 2, playerSize);
                }
            }
            if (isHit && hitTimer > 0) {
                flashAndShakePlayer();
                hitTimer--;
                if (hitTimer <= 0) {
                    isHit = false;
                }
            } else {
                fill(playerColor);
                square(playerPosition.x - playerSize / 2, playerPosition.y - playerSize / 2, playerSize);
            }
            if (isYellowEffectActive) {
                yellowEffectTimer--;
                if (yellowEffectTimer <= 0) {
                    isYellowEffectActive = false;
                }
            }
        }

        function drawPowerUps() {
            powerUps.forEach((powerUp, index) => {
                if (!powerUp.collected) {
                    fill(powerUp.color);
                    ellipse(powerUp.position.x, powerUp.position.y, powerUpSize, powerUpSize);
                    if (dist(playerPosition.x, playerPosition.y, powerUp.position.x, powerUp.position.y) < playerSize / 2 + powerUpSize / 2) {
                        powerUp.collected = true;
                        score += pointValues[powerUp.color] || 0;
                        const powerUpSound = document.getElementById(`${powerUp.color}PowerUpSound`);
                        if (powerUpSound) {
                            powerUpSound.currentTime = 0;
                            powerUpSound.play();
                        }
                        switch (powerUp.color) {
                            case 'yellow':
                                yellowPowerUpsCollected++;
                                if (yellowPowerUpsCollected >= yellowPowerUpThreshold) {
                                    showUpgradeShopModal();
                                    yellowPowerUpsCollected = 0;
                                }
                                isYellowEffectActive = true;
                                yellowEffectTimer = yellowEffectDuration;
                                break;
                            case 'red':
                                currentHealth -= 5;
                                isHit = true;
                                hitTimer = hitDuration;
                                if (currentHealth <= 0) {
                                    currentHealth = 0;
                                    console.log("Game Over!");
                                }
                                break;
                            case 'blue':
                                if ((inventory['blue'] || 0) < 15) {
                                    playerSize += 5;
                                    if (playerSize > 20 + 15 * 5) {
                                        playerSize = 20 + 15 * 5;
                                    }
                                    bluePowerUpTimer = bluePowerUpDuration;
                                    isBluePowerUpActive = true;
                                }
                                break;
                            case 'green':
                                if (greenBoostCount < maxGreenBoost) {
                                    greenBoostCount++;
                                }
                                break;
                            case 'purple':
                                timer += 180;
                                break;
                        }
                        inventory[powerUp.color] = (inventory[powerUp.color] || 0) + 1;
                        if (isHit) {
                            flashAndShakePlayer();
                        }
                    }
                }
            });
        }

        function showUpgradeShopModal() {
            document.getElementById('upgradeShopModal').style.display = 'flex';
            noLoop();
        }

        function closeUpgradeShop() {
            document.getElementById('upgradeShopModal').style.display = 'none';
            loop();
        }

        function purchaseUpgrade(upgrade) {
            switch (upgrade) {
                case 'healthBoost':
                    maxHealth += 25;
                    currentHealth += 25;
                    break;
                case 'speedBoost':
                    baseSpeed += 2;
                    break;
                case 'magnet':
                    magnetActive = true;
                    magnetRadius += 50;
                    magnetStrength += 1;
                    break;
                case 'ammo':
                    if (score >= 10 && ammoTotal < 50) { // Example cost: 10 points per ammo pack
                        ammoTotal += 6;
                        score -= 10;
                    }
                    break;
            }
            closeUpgradeShop();
            yellowPowerUpsCollected = 0;
        }

        function flashAndShakePlayer() {
            if (hitTimer % 2 === 0) {
                fill(255, 0, 0);
            } else {
                fill(255);
            }
            let shakeX = random(-5, 5);
            let shakeY = random(-5, 5);
            square(playerPosition.x - playerSize / 2 + shakeX, playerPosition.y - playerSize / 2 + shakeY, playerSize);
        }
        
        function drawHealthBar() {
            fill(50);
            rect(10, 10, 200, 20);
            let healthPercentage = currentHealth / maxHealth;
            fill(255, 0, 0);
            rect(10, 10, 200 * healthPercentage, 20);
            fill(255);
            textSize(16);
            text(`Health: ${currentHealth} / ${maxHealth}`, 220, 25);
        }

        function drawScoreboard() {
            fill(255);
            textSize(32);
            textAlign(CENTER, TOP);
            text(`Score: ${score}`, width / 2, 10);
        }

        function useBoost() {
            if (greenBoostCount > 0 && !isBoosting && boostTimer <= 0) {
                isBoosting = true;
                boostTimer = boostCooldown;
                greenBoostCount--;
            }
        }

        function handleBoost() {
            if (isBoosting) {
                isGreenPowerUpActive = true;
                boostTimer--;
                if (boostTimer <= 0) {
                    isBoosting = false;
                    isGreenPowerUpActive = false;
                    boostTimer = boostCooldown;
                }
            } else if (boostTimer > 0) {
                boostTimer--;
            }
        }

        function handleReload() {
            if (isReloading) {
                reloadTimer--;
                if (reloadTimer <= 0) {
                    let reloadAmount = min(6 - ammoClip, ammoTotal);
                    ammoClip += reloadAmount;
                    ammoTotal -= reloadAmount;
                    isReloading = false;
                }
            }
        }

        function startReload() {
            isReloading = true;
            reloadTimer = reloadDuration;
        }

        function shootProjectile() {
            let direction = p5.Vector.sub(createVector(mouseX, mouseY), playerPosition);
            direction.normalize();
            direction.mult(10); // Bullet speed
            let bullet = {
                position: playerPosition.copy(),
                velocity: direction,
                size: 8,
                color: color(255, 255, 0)
            };
            projectiles.push(bullet);
            ammoClip--;
        }

        function handleProjectiles() {
            for (let i = projectiles.length - 1; i >= 0; i--) {
                let p = projectiles[i];
                p.position.add(p.velocity);
                fill(p.color);
                noStroke();
                ellipse(p.position.x, p.position.y, p.size, p.size);
                // Remove projectile if it goes off-screen
                if (p.position.x < 0 || p.position.x > width || p.position.y < 0 || p.position.y > height) {
                    projectiles.splice(i, 1);
                }
            }
        }

        function addPowerUps(count) {
            const colors = ['blue', 'red', 'yellow', 'green', 'purple', 'purple'];
            for (let i = 0; i < count; i++) {
                powerUps.push({
                    position: createVector(random(width), random(height)),
                    color: random(colors),
                    collected: false
                });
            }
        }

        function maybeAddPowerUp() {
            if (frameCount % 60 === 0) {
                addPowerUps(1);
            }
        }

        function updateHighScore(finalScore) {
            let highScore = parseFloat(localStorage.getItem('highScore') || '0');
            if (finalScore > highScore) {
                localStorage.setItem('highScore', finalScore.toString());
            }
        }
        
        function updateAndDisplayTimer() {
            if (timer > 0) {
                timer--;
                let seconds = timer / 60;
                fill(255);
                textSize(32);
                textAlign(RIGHT, TOP);
                text(`Time: ${seconds.toFixed(1)}`, width - 10, 10);
            }
        }

        function displayHUD() {
            // Ammo HUD
            let ammoX = 10;
            let ammoY = height - 60;
            let ammoSpacing = 30;
            for (let i = 0; i < 6; i++) {
                if (i < ammoClip) {
                    fill(255, 255, 0); // Filled circle for available ammo
                } else {
                    noFill();
                }
                stroke(255);
                ellipse(ammoX + i * ammoSpacing, ammoY, 20, 20);
            }

            // Reload Indicator
            if (isReloading) {
                push();
                translate(ammoX + 3 * ammoSpacing, ammoY);
                rotate((frameCount % 360) * PI / 180);
                noFill();
                stroke(0, 255, 0);
                strokeWeight(4);
                arc(0, 0, 30, 30, 0, map(reloadTimer, 0, reloadDuration, 0, TWO_PI));
                pop();
            }

            // Green Boost HUD
            let boostX = 10;
            let boostY = height - 20;
            let boostSpacing = 30;
            for (let i = 0; i < maxGreenBoost; i++) {
                if (i < greenBoostCount) {
                    fill(0, 255, 0); // Filled circle for available boosts
                } else {
                    noFill();
                }
                stroke(255);
                ellipse(boostX + i * boostSpacing, boostY, 20, 20);
            }

            // Boost Cooldown Indicator
            if (boostTimer > 0) {
                fill(255, 0, 0, 150);
                noStroke();
                rect(10, height - 80, map(boostTimer, 0, boostCooldown, 0, 100), 10);
                fill(255);
                textSize(12);
                textAlign(LEFT, TOP);
                text(`Boost Cooldown: ${(boostTimer / 60).toFixed(1)}s`, 10, height - 90);
            }

            // Boosting Indicator
            if (isBoosting) {
                fill(0, 255, 0);
                noStroke();
                textSize(16);
                textAlign(LEFT, TOP);
                text("Boosting!", 150, height - 60);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('unmuteButton')?.addEventListener('click', function() {
                const bgMusic = document.getElementById('bgMusic');
                bgMusic.muted = !bgMusic.muted;
                this.textContent = bgMusic.muted ? 'Unmute Audio' : 'Mute Audio';
            });
            document.getElementById('submitScoreBtn')?.addEventListener('click', submitScoreWrapper);
        });

        // Uncomment and implement if needed
        /*
        function submitScoreWrapper() {
            const initials = document.getElementById('playerInitials').value.trim();
            if(initials) {
                submitScore(initials, globalFinalScore.toFixed(2));
            } else {
                alert("Please enter your initials.");
            }
        }

        function submitScore(initials, finalScore) {
            fetch('https://script.google.com/macros/s/AKfycbwYJ5duzSekbLCApNO2OB57AYe7_Ay_z1CVsvLQrkY/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ initials: initials, score: finalScore })
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }

        function fetchLeaderboard() {
          fetch('https://script.google.com/macros/s/AKfycbwYJ5duzSekbLCApNO2OB57AYe7_Ay_z1CVsvLQrkY/exec')
          .then(response => response.json())
          .then(data => {
            console.log(data);
          });
        }
        */
    </script>
</body>
</html>
