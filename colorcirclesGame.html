<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Power-Up Collection Game with Enhanced Mechanics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: center;
            }
            #modalInstructions {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                text-align: center;
            }
            #modalInstructions button {
                padding: 10px 20px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 20px;
            }
            #gameOverModal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                text-align: center;
            }
            #gameOverModal button {
                padding: 10px 20px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 20px;
            }
        </style>
</head>
<body>
    <div id="modalInstructions">
        <p>Collect as many yellow circles as you can before time runs out.</p>
        <p>Collecting purple circles gives you more time.</p>
        <p>Blue circles temporarily make you bigger. Green ones boost you.</p>
        <p>Avoid Red all together!</p>
        <p>Use arrow keys or WASD to move.</p>
        <button onclick="startGame()">Start Game</button>
    </div>
    <div id="gameOverModal" style="display:none;">
    <p>Game Over</p>
    <button onclick="restartGame()">Restart Game</button>
</div>
    <script>
        let playerPosition;
        let playerSize = 20; // Default player size
        let powerUps = [];
        let powerUpSize = 15;
        let inventory = {};
        let showInventory = false;
        let isBluePowerUpActive = false;
        let bluePowerUpDuration = 300; // Adjusted duration for using multiple blue power-ups
        let bluePowerUpTimer = 0;
        let score = 0;
        let timer; // Timer for countdown
        let timerDuration = 600; // 10 seconds * 60 fps
        let isGreenPowerUpActive = false;
        let greenPowerUpDuration = 5; // Duration in frames
        let greenPowerUpTimer = 0;
        let velocityBoost = 5; // The amount by which the velocity is multiplied
        let inventoryDiv; // Declare a variable to hold the inventory div
        let maxHealth = 100;
        let currentHealth = maxHealth;
        let redCircleSpeedIncrement = 0.1; // Amount to increase speed by
        let speedIncreaseInterval = 8; // Time in seconds after which to increase speed
        let lastSpeedIncreaseTime = 0; // Keep track of the last time the speed was increased, initially 0


        function startGame() {
            document.getElementById('modalInstructions').style.display = 'none';
            loop(); // Restart the drawing loop if it was stopped.
        }

        function setup() {
            createCanvas(800, 640);
            playerPosition = createVector(width / 2, height / 2);
            addPowerUps(5); // Initial set of power-ups
            timer = timerDuration; // Initialize the timer
            noLoop(); // Stop the drawing loop until the game starts.
        }

        function checkGameOver() {
            if (currentHealth <= 0 || timer <= 0) {
                showGameOverModal();
                noLoop(); // Pause the game
            }
        }
        
        function showGameOverModal() {
            document.getElementById('gameOverModal').style.display = 'flex';
        }
        
        function restartGame() {
            // Reset game state variables
            currentHealth = maxHealth;
            timer = timerDuration;
            score = 0;
            powerUps = []; // Clear existing power-ups
            addPowerUps(5); // Add initial power-ups
            playerPosition = createVector(width / 2, height / 2); // Reset player position
            
            // Hide game over modal and restart the game loop
            document.getElementById('gameOverModal').style.display = 'none';
            loop();
        }
        
        function draw() {
            background(0);
            handlePlayerInput();
            if ((millis() / 1000) - lastSpeedIncreaseTime >= speedIncreaseInterval) {
                redCircleBaseSpeed += redCircleSpeedIncrement;
                lastSpeedIncreaseTime = millis() / 1000; // Update the last speed increase time to the current time
                console.log("Red circle speed increased to:", redCircleBaseSpeed);
            }
            updatePowerUps()
            powerUps.forEach(powerUp => {
                if (!powerUp.collected && powerUp.color === 'red') {
                    let direction = createVector(playerPosition.x - powerUp.position.x, playerPosition.y - powerUp.position.y);
                    direction.normalize(); // Normalize the direction vector
                    direction.mult(redCircleBaseSpeed); // Apply the current speed, which increases over time
                    powerUp.position.add(direction);
                }
            });
        
            if (isBluePowerUpActive) {
                bluePowerUpTimer--;
                let lineX = playerPosition.x + playerSize / 2 + 10;
                let lineLength = map(bluePowerUpTimer, 0, bluePowerUpDuration, 0, 50);
                stroke(255); strokeWeight(3);
                line(lineX, playerPosition.y - lineLength / 2, lineX, playerPosition.y + lineLength / 2);
                stroke(0, 0, 255); strokeWeight(1);
                line(lineX, playerPosition.y - lineLength / 2, lineX, playerPosition.y + lineLength / 2);
                noStroke();
                if (bluePowerUpTimer <= 0) {
                    isBluePowerUpActive = false;
                    playerSize = 20;
                    inventory['blue'] = 0;
                }
            }
        
            if (isGreenPowerUpActive && greenPowerUpTimer > 0) {
                greenPowerUpTimer--;
                if (greenPowerUpTimer <= 0) {
                    isGreenPowerUpActive = false;
                }
            }
            // Draw the gameplay area boundary if needed
            stroke(255); // White color for visibility
            line(0, height - 40, width, height - 40); // Draw a line to separate the gameplay area and inventory
            noStroke();// Reset stroke for other drawings
            drawPlayer();
            drawPowerUps();
            updateAndDisplayTimer(); // Update and display the timer
            //if (showInventory) {
                //drawInventory();
            //}
            drawHealthBar()
            drawScoreboard(); // Call to draw the scoreboard
            maybeAddPowerUp(); // Add more power-ups over time
            //drawInventory(); // Always draw the inventory below the game area
            displayInventory();
            checkGameOver();
        }

        function updatePowerUps() {
            powerUps.forEach(powerUp => {
                if (!powerUp.collected && powerUp.color === 'red') {
                    // Calculate direction towards the player
                    let direction = createVector(playerPosition.x - powerUp.position.x, playerPosition.y - powerUp.position.y);
                    direction.normalize(); // Normalize the direction vector
        
                    // Define the speed of the red circle's movement towards the player
                    let speed = 1; // Adjust speed as needed
                    direction.mult(speed);
        
                    // Update the power-up's position
                    powerUp.position.add(direction);
                }
            });
        }

        function displayInventory() {
            fill(255); // White color for text
            textSize(16); // Adjust text size as needed
            textAlign(LEFT, TOP); // Align text to the left top
            let inventoryText = 'Inventory: ';
            const startY = height - 35; // Start Y position for inventory text
        
            for (const [color, count] of Object.entries(inventory)) {
                inventoryText += `${color.toUpperCase()}: ${count} | `;
            }
            text(inventoryText, 10, startY); // Display inventory text starting from the left margin
        }
        
        function keyPressed() {
            //if (key === 'i' || key === 'I') {
                //showInventory = !showInventory;
            //} else if (key === '1') {
                //usePowerUp('blue');
            //}
        }

        function handlePlayerInput() {
            let speed = 5; // Base speed
            // Increase speed if green power-up is active
            if (isGreenPowerUpActive) {
                speed *= velocityBoost;
            }
            // Move Up - W or Arrow Up
            if (keyIsDown(87) || keyIsDown(UP_ARROW)) {
                playerPosition.y -= speed;
            }
            // Move Down - S or Arrow Down
            if (keyIsDown(83) || keyIsDown(DOWN_ARROW)) {
                playerPosition.y += speed;
            }
            // Move Left - A or Arrow Left
            if (keyIsDown(65) || keyIsDown(LEFT_ARROW)) {
                playerPosition.x -= speed;
            }
            // Move Right - D or Arrow Right
            if (keyIsDown(68) || keyIsDown(RIGHT_ARROW)) {
                playerPosition.x += speed;
            }
            // Wrap around screen edges
            if (playerPosition.y < 0) playerPosition.y = height;
            if (playerPosition.y > height) playerPosition.y = 0;
            if (playerPosition.x < 0) playerPosition.x = width;
            if (playerPosition.x > width) playerPosition.x = 0;
        }


        function drawPlayer() {
            fill(255);
            square(playerPosition.x - playerSize / 2, playerPosition.y - playerSize / 2, playerSize);
        }

        function drawPowerUps() {
            powerUps.forEach((powerUp, index) => {
                if (!powerUp.collected) {
                    fill(powerUp.color);
                    ellipse(powerUp.position.x, powerUp.position.y, powerUpSize, powerUpSize);
                    if (dist(playerPosition.x, playerPosition.y, powerUp.position.x, powerUp.position.y) < playerSize / 2 + powerUpSize / 2) {
                        powerUp.collected = true;
                        // Update for red power-ups
                        if (powerUp.color === 'red') {
                            currentHealth -= 5; // Deduct 5 health points for each red circle hit
                            if (currentHealth <= 0) {
                                // Handle game over scenario
                                currentHealth = 0;
                                console.log("Game Over!"); // Placeholder action
                            }
                        }
                        // Existing inventory update for all power-ups
                        inventory[powerUp.color] = (inventory[powerUp.color] || 0) + 1;
                        
                        // Specific logic for blue power-ups
                        if (powerUp.color === 'blue') {
                            if ((inventory['blue'] || 0) < 15) {
                                playerSize += 5; // Temporarily increase size
                                if (playerSize > 20 + 15 * 5) {
                                    playerSize = 20 + 15 * 5; // Ensure player size does not exceed maximum growth
                                }
                                bluePowerUpTimer = bluePowerUpDuration; // Refresh or extend the timer
                                isBluePowerUpActive = true;
                            }
                        } else if (powerUp.color === 'green') {
                            // Logic for green power-ups (velocity boost)
                            isGreenPowerUpActive = true;
                            greenPowerUpTimer = greenPowerUpDuration;
                        }
                        // Handle other power-up effects here...
                        if (powerUp.color === 'purple') {
                            timer += 180; // Add time
                        }
                        if (powerUp.color === 'yellow') {
                            score++; // Increase score
                        }
                    }
                }
            });
        }

        function drawHealthBar() {
            // Health bar background
            fill(50); // Dark grey background for contrast
            rect(10, 10, 200, 20); // Adjust size and position as needed
        
            // Health bar foreground
            let healthPercentage = currentHealth / maxHealth;
            fill(255, 0, 0); // Red foreground for health
            rect(10, 10, 200 * healthPercentage, 20); // Width based on current health
        
            // Optional: Health text
            fill(255); // White text color
            textSize(16);
            text(`Health: ${currentHealth} / ${maxHealth}`, 220, 25); // Position next to the health bar
        }
        
        // Call drawHealthBar() within the draw() function
        drawHealthBar();

        function drawScoreboard() {
            fill(255);
            textSize(32);
            textAlign(CENTER, TOP);
            text(`Score: ${score}`, width / 2, 10);
        }
        
        function drawInventory() {
            // Assuming inventory is an object with keys as color names and values as counts
            const inventoryDisplay = document.getElementById('inventoryDisplay');
            let inventoryText = 'Inventory: ';
            for (const [color, count] of Object.entries(inventory)) {
                inventoryText += `${color.toUpperCase()}: ${count} | `;
            }
            inventoryDisplay.innerHTML = inventoryText.slice(0, -2); // Remove the last "|"
        }

        function usePowerUp(color) {
            if (color === 'blue' && inventory[color] && inventory[color] > 0) {
                playerSize += inventory[color] * 5; // Increase size based on blue power-ups collected
                bluePowerUpTimer = bluePowerUpDuration + (inventory[color] * 10); // Optional: Increase duration based on power-ups used
                inventory[color] = 0; // Use up all blue power-ups
                isBluePowerUpActive = true;
            }
        }

        function addPowerUps(count) {
            const colors = ['blue', 'red', 'yellow', 'green', 'purple'];
            for (let i = 0; i < count; i++) {
                powerUps.push({
                    position: createVector(random(width), random(height)),
                    color: random(colors),
                    collected: false
                });
            }
        }

        function maybeAddPowerUp() {
            if (frameCount % 60 === 0) {
                addPowerUps(1);
            }
        }

        function updateAndDisplayTimer() {
            if (timer > 0) {
                timer--;
                let seconds = timer / 60;
                fill(255); // White color for text
                textSize(32); // Size of the text
                textAlign(RIGHT, TOP); // Align text to the right and top
                text(`Time: ${seconds.toFixed(1)}`, width - 10, 10); // Position the text at the top right corner
            }
        }

    </script>
</body>
</html>
