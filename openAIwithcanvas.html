<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Resource Management Game with Upgrade Shop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #modalInstructions, #gameOverModal, #upgradeShopModal, #victoryModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            z-index: 1001;
        }
        #modalInstructions button, #gameOverModal button, #upgradeShopModal button, #victoryModal button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        #testModeDiv {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1002;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #sliderControls {
            margin-top: 10px;
            display: none;
        }
        #hud {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1003;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            width: 200px;
        }
        #healthBarContainer {
            width: 100%;
            background-color: #555;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        #healthBar {
            height: 20px;
            background-color: #f00;
            width: 100%;
            border-radius: 5px;
        }
        .resource {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .resource img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="modalInstructions">
        <p>Welcome to the Resource Management Game!</p>
        <p>Manage resources effectively, collect valuable items, and upgrade your abilities.</p>
        <button onclick="game.startGame()">Start Game</button>
    </div>
    <div id="upgradeShopModal" style="display:none;">
        <h2>Upgrade Shop</h2>
        <p>You have collected enough resources to access the upgrade shop.</p>
        <p>Available Upgrades:</p>
        <button onclick="game.purchaseUpgrade('healthBoost')">Health Boost (+25 HP)</button>
        <button onclick="game.purchaseUpgrade('workerEfficiency')">Worker Efficiency (+10%)</button>
        <button onclick="game.purchaseUpgrade('resourceMagnet')">Resource Magnet (Increase radius by 20)</button>
        <button onclick="game.closeUpgradeShop()">Close</button>
    </div>
    <div id="victoryModal" style="display:none;">
        <h2>Victory!</h2>
        <p>Congratulations! You have successfully defended against all enemies and managed your resources effectively.</p>
        <button onclick="game.restartGame()">Play Again</button>
    </div>
    <div id="gameOverModal" style="display:none;">
        <h2>Game Over</h2>
        <p>You have been defeated. Better luck next time!</p>
        <button onclick="game.restartGame()">Try Again</button>
    </div>
    <div id="testModeDiv">
        <label>
            <input type="checkbox" id="testModeCheckbox" onclick="game.toggleTestMode()" /> Test Mode
        </label>
        <div id="sliderControls">
            <label>Enemy Spawn Interval: <input type="range" id="enemySpawnIntervalSlider" min="500" max="5000" value="3000" onchange="game.updateSettings()" /> <span id="enemySpawnIntervalValue">3000</span> ms</label><br>
            <label>Enemy Speed: <input type="range" id="enemySpeedSlider" min="1" max="10" value="3" onchange="game.updateSettings()" /> <span id="enemySpeedValue">3</span></label><br>
            <label>Enemy Damage: <input type="range" id="enemyDamageSlider" min="5" max="50" value="20" onchange="game.updateSettings()" /> <span id="enemyDamageValue">20</span></label><br>
            <label>Resource Multiplier: <input type="range" id="resourceMultiplierSlider" min="1" max="5" value="1" step="0.1" onchange="game.updateSettings()" /> <span id="resourceMultiplierValue">1.0</span></label>
        </div>
    </div>
    <div id="hud">
        <div id="healthBarContainer">
            <div id="healthBar"></div>
        </div>
        <div class="resource">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/4e/Gold_ingot_icon.png" alt="Gold Icon">
            <span>Gold: <span id="goldDisplay">0</span></span>
        </div>
        <div class="resource">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6c/Tree_icon.png" alt="Wood Icon">
            <span>Wood: <span id="woodDisplay">0</span></span>
        </div>
        <div class="resource">
            <img src="https://upload.wikimedia.org/wikipedia/commons/1/1e/Food_icon.png" alt="Food Icon">
            <span>Food: <span id="foodDisplay">0</span></span>
        </div>
    </div>
    <script>
        class Player {
            constructor() {
                this.position = createVector(400, 300); // Set initial position with fixed values for setup
                this.health = 100;
                this.maxHealth = 100;
                this.hasShield = false; // Add shield property for power-up
            }
            update() {
                if (keyIsDown(LEFT_ARROW)) {
                    this.position.x -= 5;
                }
                if (keyIsDown(RIGHT_ARROW)) {
                    this.position.x += 5;
                }
                if (keyIsDown(UP_ARROW)) {
                    this.position.y -= 5;
                }
                if (keyIsDown(DOWN_ARROW)) {
                    this.position.y += 5;
                }
                this.position.x = constrain(this.position.x, 0, width);
                this.position.y = constrain(this.position.y, 0, height);
            }
            draw() {
                fill(0, 0, 255);
                ellipse(this.position.x, this.position.y, 30, 30);
                if (this.hasShield) {
                    noFill();
                    stroke(0, 255, 0);
                    ellipse(this.position.x, this.position.y, 50, 50); // Draw a shield outline
                    noStroke();
                }
            }
        }

        class Enemy {
            constructor(type) {
                this.size = type === 'seeker' ? 20 : random(20, 50);
                this.health = this.size < 35 ? 50 : 100;
                this.damage = (this.size >= 35 ? 20 : 10) * game.enemyDamageMultiplier;
                this.speed = type === 'seeker' ? 2 : random(1, 3);
                this.color = type === 'seeker' ? 'green' : (this.size < 35 ? 'red' : 'blue');
                this.type = type;
                this.position = createVector(width, random(height));
            }
            update() {
                if (this.type === 'seeker') {
                    let direction = p5.Vector.sub(game.player.position, this.position);
                    direction.setMag(this.speed * game.enemySpeedMultiplier);
                    this.position.add(direction);
                } else {
                    this.position.x -= this.speed * game.enemySpeedMultiplier;
                }
            }
            draw() {
                fill(this.color);
                rect(this.position.x, this.position.y, this.size, this.size);
            }
        }

        class PowerUp {
            constructor(type) {
                this.type = type;
                this.position = createVector(random(width), random(height));
                this.size = 20;
                this.color = type === 'shield' ? 'yellow' : 'purple';
            }
            draw() {
                fill(this.color);
                ellipse(this.position.x, this.position.y, this.size, this.size);
            }
        }

        class Game {
            constructor() {
                this.player = new Player();
                this.enemies = [];
                this.powerUps = [];
                this.resources = {
                    gold: 0,
                    wood: 0,
                    food: 0,
                };
                this.enemySpawnInterval = 3000;
                this.lastEnemySpawnTime = 0;
                this.powerUpSpawnInterval = 8000;
                this.lastPowerUpSpawnTime = 0;
                this.totalEnemiesDefeated = 0;
                this.victoryThreshold = 50;
                this.testMode = false;
                this.enemySpeedMultiplier = 1.0;
                this.enemyDamageMultiplier = 1.0;
                this.resourceMultiplier = 1.0;
            }

            startGame() {
                document.getElementById('modalInstructions').style.display = 'none';
                this.lastEnemySpawnTime = millis(); // Set initial spawn time to start counting from
                this.lastPowerUpSpawnTime = millis();
                loop();
            }

            update() {
                this.player.update();
                this.updateEnemies();
                this.updatePowerUps();
                this.checkCollisions();
                this.checkVictoryCondition();
            }

            draw() {
                background(200);
                this.player.draw();
                this.drawEnemies();
                this.drawPowerUps();
                this.updateHUD();
            }

            updateEnemies() {
                let currentTime = millis();
                if (currentTime - this.lastEnemySpawnTime > this.enemySpawnInterval) {
                    const enemyType = random() < 0.2 ? 'seeker' : 'regular';
                    this.enemies.push(new Enemy(enemyType));
                    this.lastEnemySpawnTime = currentTime;
                }
                this.enemies.forEach(enemy => enemy.update());
                this.enemies = this.enemies.filter(enemy => enemy.position.x + enemy.size > 0);
            }

            drawEnemies() {
                this.enemies.forEach(enemy => enemy.draw());
            }

            updatePowerUps() {
                let currentTime = millis();
                if (currentTime - this.lastPowerUpSpawnTime > this.powerUpSpawnInterval) {
                    const powerUpType = random() < 0.5 ? 'shield' : 'health';
                    this.powerUps.push(new PowerUp(powerUpType));
                    this.lastPowerUpSpawnTime = currentTime;
                }
            }

            drawPowerUps() {
                this.powerUps.forEach(powerUp => powerUp.draw());
            }

            checkCollisions() {
                this.enemies.forEach((enemy, index) => {
                    let d = dist(this.player.position.x, this.player.position.y, enemy.position.x + enemy.size / 2, enemy.position.y + enemy.size / 2);
                    if (d < enemy.size / 2 + 15) {
                        if (this.player.hasShield) {
                            this.player.hasShield = false; // Shield absorbs the hit
                            this.enemies.splice(index, 1);
                        } else {
                            this.player.health -= enemy.damage;
                            this.enemies.splice(index, 1);
                        }
                        this.totalEnemiesDefeated++;
                        if (this.player.health <= 0 && !this.testMode) {
                            this.gameOver();
                        }
                    }
                });

                this.powerUps.forEach((powerUp, index) => {
                    let d = dist(this.player.position.x, this.player.position.y, powerUp.position.x, powerUp.position.y);
                    if (d < powerUp.size / 2 + 15) {
                        if (powerUp.type === 'shield') {
                            this.player.hasShield = true;
                        } else if (powerUp.type === 'health') {
                            this.player.health = min(this.player.health + 20, this.player.maxHealth);
                        }
                        this.powerUps.splice(index, 1);
                    }
                });
            }

            checkVictoryCondition() {
                if (this.totalEnemiesDefeated >= this.victoryThreshold) {
                    this.victory();
                }
            }

            victory() {
                noLoop();
                document.getElementById('victoryModal').style.display = 'flex';
            }

            gameOver() {
                noLoop();
                document.getElementById('gameOverModal').style.display = 'flex';
            }

            restartGame() {
                this.player = new Player();
                this.enemies = [];
                this.powerUps = [];
                this.totalEnemiesDefeated = 0;
                this.resources = { gold: 0, wood: 0, food: 0 };
                document.getElementById('victoryModal').style.display = 'none';
                document.getElementById('gameOverModal').style.display = 'none';
                this.lastEnemySpawnTime = millis(); // Reset enemy spawn time
                this.lastPowerUpSpawnTime = millis();
                loop();
            }

            toggleTestMode() {
                this.testMode = document.getElementById('testModeCheckbox').checked;
                document.getElementById('sliderControls').style.display = this.testMode ? 'block' : 'none';
            }

            updateSettings() {
                this.enemySpawnInterval = parseInt(document.getElementById('enemySpawnIntervalSlider').value);
                document.getElementById('enemySpawnIntervalValue').textContent = this.enemySpawnInterval;
                this.enemySpeedMultiplier = parseFloat(document.getElementById('enemySpeedSlider').value);
                document.getElementById('enemySpeedValue').textContent = this.enemySpeedMultiplier;
                this.enemyDamageMultiplier = parseFloat(document.getElementById('enemyDamageSlider').value);
                document.getElementById('enemyDamageValue').textContent = this.enemyDamageMultiplier;
                this.resourceMultiplier = parseFloat(document
