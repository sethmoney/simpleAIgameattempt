<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Resource Management Game with Upgrade Shop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #modalInstructions, #gameOverModal, #upgradeShopModal, #victoryModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            z-index: 1001;
        }
        #modalInstructions button, #gameOverModal button, #upgradeShopModal button, #victoryModal button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        #testModeDiv {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1002;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #sliderControls {
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="modalInstructions">
        <p>Welcome to the Resource Management Game!</p>
        <p>Manage resources effectively, collect valuable items, and upgrade your abilities.</p>
        <button onclick="startGame()">Start Game</button>
    </div>
    <div id="upgradeShopModal" style="display:none;">
        <h2>Upgrade Shop</h2>
        <p>You have collected enough resources to access the upgrade shop.</p>
        <p>Available Upgrades:</p>
        <button onclick="purchaseUpgrade('healthBoost')">Health Boost (+25 HP)</button>
        <button onclick="purchaseUpgrade('workerEfficiency')">Worker Efficiency (+10%)</button>
        <button onclick="purchaseUpgrade('resourceMagnet')">Resource Magnet (Increase radius by 20)</button>
        <button onclick="closeUpgradeShop()">Close</button>
    </div>
    <div id="victoryModal" style="display:none;">
        <h2>Victory!</h2>
        <p>Congratulations! You have successfully defended against all enemies and managed your resources effectively.</p>
        <button onclick="restartGame()">Play Again</button>
    </div>
    <div id="gameOverModal" style="display:none;">
        <h2>Game Over</h2>
        <p>You have been defeated. Better luck next time!</p>
        <button onclick="restartGame()">Try Again</button>
    </div>
    <div id="testModeDiv">
        <label>
            <input type="checkbox" id="testModeCheckbox" onclick="toggleTestMode()" /> Test Mode
        </label>
        <div id="sliderControls">
            <label>Enemy Spawn Interval: <input type="range" id="enemySpawnIntervalSlider" min="500" max="5000" value="3000" onchange="updateSettings()" /> <span id="enemySpawnIntervalValue">3000</span> ms</label><br>
            <label>Enemy Speed: <input type="range" id="enemySpeedSlider" min="1" max="10" value="3" onchange="updateSettings()" /> <span id="enemySpeedValue">3</span></label><br>
            <label>Enemy Damage: <input type="range" id="enemyDamageSlider" min="5" max="50" value="20" onchange="updateSettings()" /> <span id="enemyDamageValue">20</span></label><br>
            <label>Resource Multiplier: <input type="range" id="resourceMultiplierSlider" min="1" max="5" value="1" step="0.1" onchange="updateSettings()" /> <span id="resourceMultiplierValue">1.0</span></label>
        </div>
    </div>
    <script>
        let currentHealth = 100;
        let maxHealth = 100;
        let resources = {
            gold: 0,
            wood: 0,
            food: 0,
        };
        let upgradeCosts = {
            healthBoost: 20, // Cost in gold
            workerEfficiency: 15, // Cost in gold
            resourceMagnet: 30, // Cost in gold
        };
        let efficiencyMultiplier = 1.0;
        let resourceMagnetRadius = 50;
        let enemies = []; // Array to hold enemy objects
        let enemySpawnInterval = 3000; // Spawn new enemy every 3 seconds
        let lastEnemySpawnTime = 0; // Time tracker for enemy spawning
        let totalEnemiesDefeated = 0; // Track total enemies defeated for endgame scenario
        let victoryThreshold = 50; // Number of enemies to defeat to win the game
        let testMode = false; // Test mode flag
        let enemySpeedMultiplier = 1.0; // Enemy speed multiplier for test mode
        let enemyDamageMultiplier = 1.0; // Enemy damage multiplier for test mode
        let resourceMultiplier = 1.0; // Resource collection multiplier for test mode

        function setup() {
            createCanvas(800, 600); // Create the canvas for the game
            noLoop(); // Start with the game loop stopped
        }
        
        function startGame() {
            document.getElementById('modalInstructions').style.display = 'none';
            loop(); // Start game loop
        }
        
        function showUpgradeShopModal() {
            document.getElementById('upgradeShopModal').style.display = 'flex';
            noLoop(); // Pause game while in the upgrade shop
        }

        function closeUpgradeShop() {
            document.getElementById('upgradeShopModal').style.display = 'none';
            loop(); // Resume game loop after closing the shop
        }
        
        // Function to purchase an upgrade
        function purchaseUpgrade(upgrade) {
            if (resources.gold >= upgradeCosts[upgrade]) {
                resources.gold -= upgradeCosts[upgrade];
                applyUpgrade(upgrade);
                closeUpgradeShop();
            } else {
                alert("Not enough resources to purchase this upgrade!");
            }
        }
        
        // Function to apply the purchased upgrade
        function applyUpgrade(upgrade) {
            switch (upgrade) {
                case 'healthBoost':
                    maxHealth += 25;
                    currentHealth += 25;
                    break;
                case 'workerEfficiency':
                    efficiencyMultiplier += 0.1;
                    break;
                case 'resourceMagnet':
                    resourceMagnetRadius += 20;
                    break;
            }
        }

        function draw() {
            background(200);
            updateEnemies(); // Update enemy positions and states
            drawEnemies(); // Draw enemies on the canvas
            checkCollisions(); // Check for collisions between player and enemies
            checkVictoryCondition(); // Check if the player has met the victory condition
        }

        // Function to update enemies
        function updateEnemies() {
            let currentTime = millis();
            if (currentTime - lastEnemySpawnTime > enemySpawnInterval) {
                spawnEnemy(); // Spawn a new enemy
                lastEnemySpawnTime = currentTime;
            }

            // Update each enemy's position
            enemies.forEach(enemy => {
                enemy.position.x -= enemy.speed * enemySpeedMultiplier;
            });

            // Remove enemies that go off-screen
            enemies = enemies.filter(enemy => enemy.position.x + enemy.size > 0);
        }

        // Function to draw enemies
        function drawEnemies() {
            enemies.forEach(enemy => {
                fill(enemy.color);
                rect(enemy.position.x, enemy.position.y, enemy.size, enemy.size);
            });
        }

        // Function to spawn a new enemy
        function spawnEnemy() {
            let size = random(20, 50);
            let health = size < 35 ? 50 : 100; // Smaller enemies have more health
            let damage = (size >= 35 ? 20 : 10) * enemyDamageMultiplier; // Larger enemies deal more damage
            let speed = random(1, 3);
            let color = size < 35 ? 'red' : 'blue';
            // Add a new enemy to the enemies array
            enemies.push({
                position: createVector(width, random(height)),
                size: size,
                health: health,
                damage: damage,
                speed: speed,
                color: color
            });
        }

        // Function to check collisions between player and enemies
        function checkCollisions() {
            enemies.forEach((enemy, index) => {
                let d = dist(width / 2, height / 2, enemy.position.x + enemy.size / 2, enemy.position.y + enemy.size / 2);
                if (d < enemy.size / 2) {
                    currentHealth -= enemy.damage; // Reduce player health based on enemy damage
                    enemies.splice(index, 1); // Remove enemy after collision
                    totalEnemiesDefeated++; // Increment the count of defeated enemies
                    if (currentHealth <= 0 && !testMode) {
                        gameOver(); // Trigger game over if health reaches 0 and test mode is not active
                    }
                }
            });
        }

        // Function to check if the player has achieved victory
        function checkVictoryCondition() {
            if (totalEnemiesDefeated >= victoryThreshold) {
                victory(); // Trigger victory if the player defeats enough enemies
            }
        }

        // Function to handle victory
        function victory() {
            noLoop(); // Stop the game loop
            document.getElementById('victoryModal').style.display = 'flex'; // Show victory modal
        }

        // Function to handle game over
        function gameOver() {
            noLoop(); // Stop the game loop
            document.getElementById('gameOverModal').style.display = 'flex'; // Show game over modal
        }

        // Function to restart the game
        function restartGame() {
            // Reset all game variables
            currentHealth = maxHealth = 100;
            resources = { gold: 0, wood: 0, food: 0 };
            enemies = [];
            totalEnemiesDefeated = 0;
            document.getElementById('victoryModal').style.display = 'none';
            document.getElementById('gameOverModal').style.display = 'none';
            loop(); // Restart the game loop
        }

        // Function to toggle test mode
        function toggleTestMode() {
            testMode = document.getElementById('testModeCheckbox').checked;
            document.getElementById('sliderControls').style.display = testMode ? 'block' : 'none';
        }

        // Function to update game settings based on slider values
        function updateSettings() {
            enemySpawnInterval = parseInt(document.getElementById('enemySpawnIntervalSlider').value);
            document.getElementById('enemySpawnIntervalValue').textContent = enemySpawnInterval;
            enemySpeedMultiplier = parseFloat(document.getElementById('enemySpeedSlider').value);
            document.getElementById('enemySpeedValue').textContent = enemySpeedMultiplier;
            enemyDamageMultiplier = parseFloat(document.getElementById('enemyDamageSlider').value);
            document.getElementById('enemyDamageValue').textContent = enemyDamageMultiplier;
            resourceMultiplier = parseFloat(document.getElementById('resourceMultiplierSlider').value);
            document.getElementById('resourceMultiplierValue').textContent = resourceMultiplier;
        }
    </script>
</body>
</html>
